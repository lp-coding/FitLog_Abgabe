{% extends "base.html" %}
{% block title %}Training erfassen – FitLog{% endblock %}

{% block content %}
<div class="plan-edit">

  <div class="plan-header">
    <div class="col">
      <strong>Training erfassen</strong>
      <span class="muted">{{ sess.plan_name }}</span>
    </div>
    <a class="icon-btn"
       href="{{ url_for('index') }}"
       title="Schließen"
       aria-label="Schließen">×</a>
  </div>

  <form method="post"
        action="{{ url_for('sessions.finish_session', session_id=sess.id) }}"
        class="card">

    <div class="card-body">
      <div class="row gap">
        <div class="col gap">
          <label for="plan_name">Plan</label>
          <input id="plan_name"
                 class="input"
                 type="text"
                 value="{{ sess.plan_name }}"
                 readonly>
        </div>

        <div class="col gap">
          <label for="duration_minutes">Trainingsdauer (Minuten)</label>
          <input id="duration_minutes"
                 class="input-num"
                 type="number"
                 name="duration_minutes"
                 min="1" max="600" step="1"
                 placeholder="45"
                 inputmode="numeric">
        </div>
      </div>
    </div>

    <div class="table-scroll">
      <table class="table">
        <thead>
          <tr>
            <th>Übung</th>
            <th>Sätze</th>
            <th>Wdh.</th>
            <th>Gewicht (kg)</th>
            <th>Notiz</th>
          </tr>
        </thead>

        <tbody>
          {% for item in items %}
          <tr>
            <td>
              {{ item.name }}
              <input type="hidden" name="exercise_id" value="{{ item.exercise_id }}">
            </td>

            <td>
              <input class="input-num"
                     type="number"
                     name="ex[{{ item.exercise_id }}][sets]"
                     min="0" max="99" step="1"
                     value="{{ item.sets if item.sets is not none else '' }}"
                     inputmode="numeric">
            </td>

            <td>
              <input class="input-num"
                     type="number"
                     name="ex[{{ item.exercise_id }}][reps]"
                     min="1" max="999" step="1"
                     value="{{ item.reps if item.reps is not none else '' }}"
                     inputmode="numeric">
            </td>

            <td>
              <input class="input-num"
                     type="number"
                     name="ex[{{ item.exercise_id }}][weight]"
                     min="0" max="2000" step="0.5"
                     value="{% if item.weight_kg is not none %}{{ '{:.1f}'.format(item.weight_kg) }}{% endif %}"
                     inputmode="decimal">
            </td>

            <td>
              {% if item.note %}
                {{ item.note }}
              {% else %}
                <span class="muted">–</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="muted">Keine Übungen im Plan gefunden.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card-body">
      <div class="footer-bar">
        <div class="muted">
          Tipp: Wenn du eine Übung ausgelassen hast, setze „Sätze“ auf 0.
        </div>

        <div class="actions">
          <button class="btn btn-secondary"
                  type="submit"
                  formaction="{{ url_for('sessions.abort_session', session_id=sess.id) }}"
                  formmethod="post">
            Abbrechen
          </button>
          <button class="btn btn-primary" type="submit">Speichern</button>
        </div>
      </div>
    </div>

  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Clamp für Sätze (0..99)
  document.addEventListener('input', (ev) => {
    const el = ev.target;
    if (el && el.name && el.name.endsWith('[sets]')) {
      const v = Number(el.value || 0);
      if (v < 0) el.value = 0;
      if (v > 99) el.value = 99;
    }
  });
</script>
{% endblock %}
